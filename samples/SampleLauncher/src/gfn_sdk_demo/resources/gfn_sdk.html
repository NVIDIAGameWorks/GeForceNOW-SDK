<html>
<head>
    <title>NVIDIA GeForce NOW SDK Sample</title>
    <style>
        body {
            left: 0;
            top: 0;
            width: 512px;
            height: 900px;
            background: #191919;
            margin: 0 !important;
            overflow: hidden;
            user-select: none;
        }

        .parent {
            padding: 8px;
        }

        .coverart-container {
            display: flex;
            width: 480px;
            height: 270px;
        }

        .coverart {
            display: inline;
            flex: 1;
            width: 100%;
            height: 100%;
        }

        .coverart-backup {
            display: none;
            flex: 1;
            color: white;
            text-align: center;
            font-size: 16px;
        }

        .nv-button {
            background-color: #76b900;
            border: none;
            color: white;
            text-align: center;
            font-size: 14px;
            width: 125px;
            height: 48px;
            cursor: pointer;
        }

        .nv-chevron {
            /**
             * Buttons must be small to stay outside TV_BANNER's name area to avoid occluding title name.
            **/
            height: 28px;
            width: 28px;
            font-weight: bolder;
            font-size: 20px;
            position: absolute;
            top: 119px;
            border-color: white;
            border-width: 1px;
            border-style: solid;
            box-shadow: 0 0 2px 1px rgb(0,0,0);
        }

        .nv-chevron-right-align {
            left: 460px;
        }

        .nv-button:not(:last-of-type) {
            margin-right: 8px;
        }

        .nv-button-disabled {
            background-color: #BABABA;
            border: none;
            color: white;
            text-align: center;
            font-size: 14px;
            width: 125px;
            height: 48px;
            disabled;
        }

        .nv-button-disabled:not(:last-of-type) {
            margin-right: 8px;
        }

        .spacer {
            flex-grow: 1;
        }

        .nv-container {
            width: 480px;
            margin-top: 8px;
            display: flex;
            flex-direction: row;
            color: white;
            font-size: 14px;
            font-family: Arial;
            align-items: center;
        }

        .nv-nested-container {
            width: 480px;
            margin-top: 8px;
            display: flex;
            flex-direction: row;
            margin-left: 8px;
            align-items: center;
        }

        .input {
            height: 20px;
            margin: 0px 8px 0px 8px;
            width: 100%;
        }

        .input-label {
            white-space: normal;
            width: 100px;
            margin-left: 12px;
            vertical-align: middle;
        }

        .text {
            margin: 0px 0px 0px 8px;
        }

        .status {
            color: #FFFFFFB3;
            background: #292929;
            border-color: #FFFFFFB3;
            height: 450px;
            width: 100%;
        }

        .flyout-container {
            display: inline-block;
            white-space: nowrap;
            max-width: 480px;
        }

        .flyout {
            flex-direction: column;
            display: inline-flex;
            flex-direction: column;
            transform-origin: top left;
            transition: transform 300ms, opacity 300ms;
            transform: rotateY(90deg) translateY(-180px);
            opacity: 0;
            position: absolute;
            white-space: normal;
        }

        .flyout_root:hover + .flyout {
            opacity: 100;
            transform: rotateY(0deg) translateY(-180px);
        }

        .flyout:hover {
            opacity: 100;
            transform: rotateY(0deg) translateY(-180px);
        }

        .flyout_root {
            display: inline-block;
        }

        .flyout-button {
            border: 2px solid black;
            width: 200px;
            height: 44px;
        }

        .flyout-button:active {
            color: black;
        }
    </style>
</head>
<body>
    <div class="parent">
        <div>
            <button class="nv-button nv-chevron" disabled id="previous-game" onclick="nextGame(-1)"><</button>
            <div id="cover-art-container" class="coverart-container">
                <img id="cover-art" class="coverart" />
                <div id="art-backup" class="coverart-backup"></div>
            </div>
            <button class="nv-button nv-chevron nv-chevron-right-align" disabled id="next-game" onclick="nextGame(1)">></button>
        </div>
        <div id="ip-address" class="nv-container" style="display: none">
            <span class="text">User's IP Address: </span><span class="text" id="ip-address-value"></span>
        </div>
        <div class="nv-container flyout-container">
            <div class="flyout_root">
                <button class="nv-button">SDK Calls ></button>
            </div>
            <div class="flyout" id="api-button-container">
                <button class="nv-button-disabled flyout-button" id="stream-action" onclick="performStreamAction()">Start Stream</button>
                <button class="nv-button-disabled flyout-button" id="init-control" onclick="toggleSdkInit()">Shutdown SDK</button>
                <button class="nv-button-disabled flyout-button" id="send-message" onclick="sendMessage('SampleLauncher: Ping')">Send Message To Game</button>
                <button class="nv-button-disabled flyout-button" id="is-running-in-cloud" onclick="getRunningInCloud()">Check If Cloud</button>
                <button class="nv-button-disabled flyout-button" id="is-running-in-cloud-secure" onclick="isRunningInCloudSecure()">Check If Cloud Secure</button>
                <button class="nv-button-disabled flyout-button" id="cloud-check-validation" onclick="cloudCheckWithValidation()">Check If Cloud<br>(With Validation)</button>
                <button class="nv-button-disabled flyout-button" id="cloud-check-no-validation" onclick="cloudCheckNoValidation()">Check If Cloud<br>(No Validation)</button>
                <button class="nv-button-disabled flyout-button" id="client-ip" onclick="getClientIp()">Get Client IP</button>
                <button class="nv-button-disabled flyout-button" id="client-country-code" onclick="getClientCountryCode()">Get Client Country Code</button>
                <button class="nv-button-disabled flyout-button" id="client-language-code" onclick="getClientLanguageCode()">Get Client Language Code</button>
                <button class="nv-button-disabled flyout-button" id="client-info" onclick="getClientInfo()">Get Client Info</button>
                <button class="nv-button-disabled flyout-button" id="session-info" onclick="getSessionInfo()">Get Session Info</button>
                <button class="nv-button-disabled flyout-button" id="partner-data" onclick="getPartnerData()">Get Partner Data</button>
                <button class="nv-button-disabled flyout-button" id="partner-secure-data" onclick="getPartnerSecureData()">Get Partner Secure Data</button>
                <button class="nv-button-disabled flyout-button" id="url-on-client" onclick="openUrlOnClient()">Open URL on Client</button>
            </div>
            <div id="login-panel" class="nv-nested-container">
                <span class="input-label">Launcher Token:</span>
                <input id="launcherToken" type="text" class="input">
            </div>
        </div>
        <div id="stream-status" class="nv-container">
            <span>Stream Status: </span><span class="text" id="stream-status-value">Init</span>
        </div>
        <div class="nv-container">
            <textarea class="status" id="status" readonly></textarea>
        </div>
    </div>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.494.0.min.js"></script>
    <script language="JavaScript">
        var gfnTitleId = null;
        var gameIndex = 0;
        var supportedTitlesAsJson = null;
        var streamRunning = false;
        var isSDKEnabled = false;

        /**
            * Adds a given input message to the console log as well as the log text box.
            * @param message Input string to be added to the log
            */
function setStatus(message) {
    console.log(message);
    var timestamp = new Date();
    var statusElement = document.getElementById('status');
    var currentText = statusElement.textContent;
    statusElement.textContent = '[' + timestamp.toLocaleTimeString() + '] ' + message + '\n' + currentText;
}

        /**
            * Initializes the NVIDIA GeForce NOW SDK and other startup values. Also checks
            * if the client is being run on a GeForce NOW game seat to show a different UI.
            */
        function initializeSdk() {
            return new Promise((resolve, reject) => {
                setStatus('Initializing GFN SDK');
                window.cefQuery({
                    request: JSON.stringify({
                        command: 'GFN_SDK_INIT'
                    }),
                    onSuccess: function (response) {
                        var data = JSON.parse(response);
                        var success = data.success;
                        if (success) {
                            setStatus('GFN SDK successfully initialized!');
                            this.isSDKEnabled = true;
                            resolve(0);
                        } else {
                            setStatus('GFN SDK not initialized: ' + data.errorMessage);
                            this.isSDKEnabled = false;
                            reject(success);
                        }
                        resolve(0);
                    },
                    onFailure: function (error_code, error_message) {
                        setStatus('GFN SDK not initialized: ' + error_message);
                        reject(error_code);
                    }
                });
            });
        }

        /**
            * Requests a callback when the streamer state changes
            */
        function registerStreamStatusCallback() {
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_REGISTER_STREAM_STATUS_CALLBACK'
                }),
                persistent: true,
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    setStatus('StreamStatus update: ' + data.status);
                    if (data.status == 'Init') {
                        streamRunning = true;
                        updateStreamButton();
                    }
                    if (data.status == 'Done' || data.status == 'Error') {
                        streamRunning = false;
                        updateStreamButton();
                    }

                    var streamStatusValue = document.getElementById('stream-status-value');
                    streamStatusValue.innerHTML = data.status;
                }
            });
        }

        /**
         * Requests a callback when on-seat client info changes
         */
        function registerClientInfoCallback() {
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_REGISTER_CLIENT_INFO_CALLBACK'
                }),
                persistent: true,
                onSuccess: function (response) {
                    setStatus('Client info update: ' + response);
                }
            });
        }

        /**
         * Requests a callback when a message is received from the client.
         */
        function registerMessageCallback(onSuccess) {
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_REGISTER_MESSAGE_CALLBACK'
                }),
                persistent: true,
                onSuccess: onSuccess
            });
        }

        /**
            * Calls into GFN SDK to determine whether the sample launcher is being executed inside
            * an NVIDIA GeForce NOW game seat. If running in the cloud it exercises other GFN SDK
            * functions like displaying the user's current local IP address, or restoring the launcher
            * user session from the IDM to demonstrate Single Sign-On behavior.
            */
        function isRunningInCloud() {
            return new Promise((resolve, reject) => {
                window.cefQuery({
                    request: JSON.stringify({
                        command: 'GFN_SDK_IS_RUNNING_IN_CLOUD'
                    }),
                    onSuccess: function (response) {
                        var data = JSON.parse(response);
                        setStatus(data.enabled ? 'Client is running on a cloud GFN game seat' : 'Client is not running on a cloud GFN game seat');

                        if (data.enabled) {
                            // Get current client IP
                            getClientIp();
                            // Get current client country code
                            getClientCountryCode();
                            // Get all the available client info
                            getClientInfo();
                            // Get all the current session info
                            getSessionInfo();
                            // Get streamable status about a specific title
                            isTitleAvailable();
                            // Get all titles available to stream in the current GFN game seat
                            getAvailableTitles();
                            // Obtain partner secure data that passed in as part of StartStream API
                            getPartnerSecureData();
                            // Obtain partner data that passed in as part of StartStream API
                            getPartnerData();
                        }
                        resolve(data.enabled);
                    }
                });
            });
        }

        /**
         * Calls into GFN SDK to determine whether the sample launcher is being executed inside
         * an NVIDIA GeForce NOW game seat. It then displays the result of the call and returns it.
         **/
        function getRunningInCloud() {
            setStatus("Calling isRunningInCloud");
            return new Promise((resolve, reject) => {
                window.cefQuery({
                    request: JSON.stringify({
                        command: 'GFN_SDK_IS_RUNNING_IN_CLOUD'
                    }),
                    onSuccess: function (response) {
                        var data = JSON.parse(response);
                        setStatus(data.enabled ? 'Client is running on a cloud GFN game seat' : 'Client is not running on a cloud GFN game seat');
                        resolve(data.enabled);
                    }
                });
            });
        }

        /**
         * Uses the secure version of the cloud check API to check if running in GFN environment. This
         * requires the sample application to be registered per Cloud Check API guide.
         **/
        function isRunningInCloudSecure() {
            return new Promise((resolve, reject) => {
                window.cefQuery({
                    request: JSON.stringify({
                        command: 'GFN_SDK_IS_RUNNING_IN_CLOUD_SECURE'
                    }),
                    onSuccess: function (response) {
                        var data = JSON.parse(response);
                        setStatus('Secure GFN cloud check result: ' + data.errorMessage);
                        setStatus('Assurance value of running in GFN cloud environment: ' + data.assurance);
                        resolve(data.assurance);
                    }
                });
            });
        }

        /**
         * Uses the new secure version of Cloud Check API to check if running in GFN environment. This requires API to be called by passing
         * nonce as challenge input. The application then validates the response received.
         **/
        function cloudCheckWithValidation() {
            return new Promise((resolve, reject) => {
                window.cefQuery({
                    request: JSON.stringify({
                        command: 'GFN_SDK_CLOUD_CHECK_WITH_VALIDATION'
                    }),
                    onSuccess: function (response) {
                        var data = JSON.parse(response);
                        setStatus('GFN CloudCheck with validation result: ' + data.errorMessage);
                        setStatus(data.isCloudEnvironment ? 'CloudCheck with validation: Client is running on a cloud GFN game seat' : 'CloudCheck with validation: Client is not running on a cloud GFN game seat');
                        resolve(data.isCloudEnvironment);
                    }
                });
            });
        }

        /**
         * Uses the new secure version of Cloud Check API to check if running in GFN environment.
         * This case demonstrates how the API can be used with null values for challenge and response.
         **/
        function cloudCheckNoValidation() {
            return new Promise((resolve, reject) => {
                window.cefQuery({
                    request: JSON.stringify({
                        command: 'GFN_SDK_CLOUD_CHECK_NO_VALIDATION'
                    }),
                    onSuccess: function (response) {
                        var data = JSON.parse(response);
                        setStatus('GFN CloudCheck with no validation result: ' + data.errorMessage);
                        setStatus(data.isCloudEnvironment ? 'CloudCheck with no validation: Client is running on a cloud GFN game seat' : 'CloudCheck with no validation: Client is not running on a cloud GFN game seat');
                        resolve(data.isCloudEnvironment);
                    }
                });
            });
        }

        function getAvailableTitles() {
            return new Promise((resolve, reject) => {
                window.cefQuery({
                    request: JSON.stringify({
                        command: 'GFN_SDK_GET_AVAILABLE_TITLES',
                    }),
                    onSuccess: function (response) {
                        var data = JSON.parse(response);
                        setStatus('Available titles result: ' + data.errorMessage);
                        setStatus('Available titles: ' + data.titles);
                    }
                });
            });
        }

        function isTitleAvailable() {
            return new Promise((resolve, reject) => {
                window.cefQuery({
                    request: JSON.stringify({
                        command: 'GFN_SDK_IS_TITLE_AVAILABLE',
                        appId: "730",   // Use the ID of your specific title of your platform
                    }),
                    onSuccess: function (response) {
                        var data = JSON.parse(response);
                        setStatus(data.available ? 'Title is available to stream' : 'Title is not available to stream');
                        resolve(data.available);
                    }
                });
            });
        }

        function getSupportedTitles() {
            var url = 'https://prod.cloudmatchbeta.nvidiagrid.net/v2/serverInfo';
            return fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw 'The serverInfo endpoint failed';
                    }
                    return response.json();
                })
                .then(function (responseJson) {
                    var serverId = responseJson.requestStatus.serverId;
                    setStatus('serverId: ' + serverId);
                    if (serverId === '') {
                        throw 'serverId value is not valid';
                    }
                    // GFN platform provides an App Catalog (LCARS) API to serve content from the other
                    // microservices to all clients. LCARS is served with a GraphQL interface. SDK Clients can
                    // use this API to specify data they want (e.g. games from a particular GFN vpcId),
                    // and LCARS will build the appropriate response.
                    const GetAppsQuery = (vpcId) =>
                        `{
                                apps(vpcId: "${vpcId}") {
                                    numberReturned
                                    items {
                                        title
                                        variants {
                                            id
                                            images {
                                                TV_BANNER
                                            }
                                            appStore
                                        }
                                    }
                                }
                            }`;
                    var url = 'https://public.games.geforce.com/graphql?query=' + encodeURIComponent(GetAppsQuery(serverId));
                    return fetch(url, {
                        method: 'GET'
                    })
                        .then(function (response) {
                            if (!response.ok) {
                                throw 'The apps endpoint failed';
                            }
                            return response.json();
                        })
                        .then(function (responseJson) {
                            let returnList = responseJson.data.apps.items;
                            return getAdditionalSupportedTitles().then(function (add_response) {
                                if (add_response && add_response.length > 0) {
                                    returnList = [...add_response, ...returnList];
                                }
                                return returnList;
                            });
                        })
                })
        }

        /**
         * Queries the native helper for any additional titles that should be shown in the list.
         */
        function getAdditionalSupportedTitles() {
            return new Promise((resolve, reject) => {
                window.cefQuery({
                    request: JSON.stringify({
                        command: 'GFN_SDK_GET_ADDITIONAL_SUPPORTED_TITLES',
                    }),
                    onSuccess: function (response) {
                        var data = JSON.parse(response);
                        resolve(data.titles);
                    },
                });
            });
        }

        /**
            * Calls into GFN SDK to initiate a new GeForce NOW streaming session and launch the currently
            * selected game, or stop it if a stream is running.
            *
            * The serviceId and appId parameters should be obtained from an NVIDIA Developer Services
            * API call which returns that information, see the nextGame() function below for an example.
            */
        function performStreamAction() {
            if (streamRunning == false) {
                setStatus('Launching game stream session...');
                var authType = 0;
                var promise = Promise.resolve(null);
                promise.then(function () {
                    window.cefQuery({
                        request: JSON.stringify({
                            command: 'GFN_SDK_STREAM_ACTION',
                            gfnTitleId: gfnTitleId,                 // GFN ID for the title to stream
                            launcherToken: document.getElementById('launcherToken').value,
                            launchStream: !streamRunning
                        }),
                        onSuccess: function (response) {
                            var data = JSON.parse(response);
                            setStatus('Game launched: ' + data.actionSuccess + ' (' + data.errorMessage + ')');
                        }
                    })
                });
            } else {
                setStatus('Stopping game stream session...');
                var promise = Promise.resolve(null)
                promise.then(function () {
                    window.cefQuery({
                        request: JSON.stringify({
                            command: 'GFN_SDK_STREAM_ACTION',
                            launchStream: !streamRunning
                        }),
                        onSuccess: function (response) {
                            var data = JSON.parse(response);
                            setStatus('Stream stop request: ' + data.actionSuccess + ' (' + data.errorMessage + ')');
                            streamRunning = false;
                            updateStreamButton();
                            var streamStatusValue = document.getElementById('stream-status-value');
                            streamStatusValue.innerHTML = "Stopped";
                        }
                    })
                });
            }
        }

        /**
         * Sends a message from the locally running launcher to the game running in the cloud.
         */
        function sendMessage(message, isCloud = false) {
            if (!isCloud && streamRunning == true) {
                setStatus('Sending message to cloud: ' + message);
            } else if (isCloud) {
                setStatus('Sending message to client: ' + message);
            } else {
                setStatus('ERROR: Invalid state, cannot Send Message');
                return;
            }

            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_SEND_MESSAGE',
                    message: message,
                }),
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    setStatus('Message sent: ' + data.actionSuccess + ' (' + data.errorMessage + ')');
                }
            });
        }

        /**
            * Goes to the next or previous game in the list of games available for streaming on GeForce NOW
            * and calls the NVIDIA Developer Services API to retrieve game metadata required for launch
            * as well as information such as game name and a URL for the cover art image, which can be
            * requested in various available formats.
            * @param increment Number of steps by which to increase or decrease the current games index
            */
        function nextGame(increment) {
            gameIndex += increment;
            if (gameIndex < 0) {
                gameIndex = supportedTitlesAsJson.length - 1;
            }
            if (gameIndex >= supportedTitlesAsJson.length) {
                gameIndex = 0;
            }

            // For this sample application, we utilize GFN artwork services. If you wish to utilize the
            // same services, contact NVIDIA for more information on doing so.
            var cover = document.getElementById('cover-art');
            var backup = document.getElementById('art-backup');

            gfnTitleId = parseInt(supportedTitlesAsJson[gameIndex].variants[0].id);

            const banner = supportedTitlesAsJson[gameIndex].variants[0].images.TV_BANNER;
            if (banner) {
                cover.src = banner;
                cover.style.display = 'inline';
                backup.innerHTML = '';
                backup.style.display = 'none';
            } else {
                cover.src = '';
                cover.style.display = 'none';
                backup.innerHTML = supportedTitlesAsJson[gameIndex].title;
                backup.style.display = 'inline';
            }

            var lastIndex = supportedTitlesAsJson.length - 1;
            setStatus('GFN Game ' + gameIndex + ' of ' + lastIndex + ':  ' + JSON.stringify(supportedTitlesAsJson[gameIndex]));
        }

        /**
         *  Toggles the initialization state of the SDK
         *
         *  When shutdown, other calls to the SDK should fail
         */
        function toggleSdkInit() {
            var toggleButton = document.getElementById('init-control');
            switch (this.isSDKEnabled) {
                case true:
                    toggleButton.innerText = 'Initialize SDK';
                    setStatus('Shutting down SDK.');
                    window.cefQuery({
                        request: JSON.stringify({
                            command: 'GFN_SDK_SHUTDOWN'
                        }),
                        onSuccess: function (response) {
                            var data = JSON.parse(response);
                            launcherToken = data.authData;
                            setStatus('GFN SDK Shutdown complete: ' + ( data.success ? 'Success' : data.errorMessage ));
                            this.isSDKEnabled = false;
                            const apiContainer = document.getElementById('api-button-container');
                            for (var child of apiContainer.children) {
                                if (child.id !== 'init-control') {
                                    child.setAttribute("class", 'nv-button-disabled flyout-button');
                                    child.disabled = true;
                                }
                            }
                        }
                    });
                    break;
                case false:
                    toggleButton.innerText = 'Shutdown SDK';
                    setStatus('Re-Initializing SDK.');
                    initializeSdk().then(function () {
                        isRunningInCloud().then(function (isCloud) {
                            setButtonState(isCloud);
                            updateStreamButton();
                        });
                    });

                    const apiContainer = document.getElementById('api-button-container');
                    for (var child of apiContainer.children) {
                        if (child.id !== 'init-control') {
                            child.setAttribute("class", 'nv-button flyout-button');
                            child.disabled = false;
                        }
                    }
                    break;
            }
        }

        /**
            * Calls into GFN SDK to request a copy of the 3rd party secure data passed into the
            * StartStream API. This token should be a token that can be consumed by your application
            * that is running inside the GFN cloud environment to facilitate Single Sign-On (SSO) and
            * thus not require the user to manually log into your application.
            */
        function getPartnerSecureData() {
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_GET_PARTNER_SECURE_DATA'
                }),
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    launcherToken = data.partnerSecureData;
                    setStatus('Partner Secure data retrieval completed: ' + data.errorMessage + ', token: "' + launcherToken + '"');
                }
            });
        }

        /**
         * Call into GFN SDK to request a URL be opened on the client's browser.
         */
        function openUrlOnClient() {
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_OPEN_URL_ON_CLIENT'
                }),
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    setStatus('Open URL Request returned with status: ' + data.status);
                }
            });
        }

        /**
         * Calls into GFN SDK to request a copy of the 3rd party data passed into the
         * StartStream API.
         */
         function getPartnerData() {
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_GET_PARTNER_DATA'
                }),
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    partnerData = data.partnerData;
                    setStatus('Partner data retrieval completed: ' + data.errorMessage + ', Data: "' + partnerData + '"');
                }
            });
        }

        /**
            * Calls into GFN SDK to get the user's current local IP address. This is meant to be
            * called while running on the GeForce NOW game seat to handle scenarios where the IP
            * addressed is used for account security or other validation purposes or things like
            * region specific localization or other UI.
            */
        function getClientIp() {
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_GET_CLIENT_IP'
                }),
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    clientIp = data.clientIp;
                    setStatus('Got client IP address: ' + clientIp + ' (' + data.errorMessage + ')');

                    if (clientIp.length > 0) {
                        var ipAddressDiv = document.getElementById('ip-address');
                        var ipAddressValue = document.getElementById('ip-address-value');
                        ipAddressValue.innerHTML = clientIp;
                        ipAddressDiv.style.display = 'flex';
                    }
                }
            });
        }

        /**
            * Calls into GFN SDK to get the user's current country code. This is meant to be
            * called while running on the GeForce NOW game seat to validation purposes or things like
            * region specific localization or other UI.
            */
        function getClientCountryCode() {
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_GET_CLIENT_COUNTRY_CODE'
                }),
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    clientCountryCode = data.clientCountryCode;
                    if (clientCountryCode.length > 0) {
                        setStatus('Got client country code: ' + clientCountryCode + ' (' + data.errorMessage + ')');
                    } else {
                        setStatus('Failed to client country code: ' + data.errorMessage);
                    }
                }
            });
        }

        /**
         * Calls into GFN SDK to get the user's current language code. This is meant to be
         * called while running on the GeForce NOW game seat to validation purposes or things like
         * region specific localization or other UI.
         */
        function getClientLanguageCode() {
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_GET_CLIENT_LANGUAGE_CODE'
                }),
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    clientLanguageCode = data.clientLanguageCode;
                    if (clientLanguageCode.length > 0) {
                        setStatus('Got client language code: ' + clientLanguageCode + ' (' + data.errorMessage + ')');
                    } else {
                        setStatus('Failed to client language code: ' + data.errorMessage);
                    }
                }
            });
        }

        /**
            * Calls into GFN SDK to get the user's client info. This is meant to be
            * called while running on the GeForce NOW game seat to make decisions based on client settings,
            * such as changing the application UI if the user's input is a game controller or touchscreen
            * versus using a keyboard and mouse.
            */
        function getClientInfo() {
            setStatus('Getting Client Info...');
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_GET_CLIENT_INFO'
                }),
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    setStatus('Got client info: ' + response);
                },
                onFailure: function (response) {
                    setStatus('Failed to get client Info: ' + JSON.stringify(response));
                }
            });
        }

        /**
            * Calls into GFN SDK to get information about current streaming session. This is meant to be
            * called while running on the GeForce NOW game seat to make decisions based on session length,
            * and how much time is remaining in the session, RTX support, as well as getting the session ID
            * for trackaing purposes.
            */
        function getSessionInfo() {
            setStatus('Getting Session Info...');
            window.cefQuery({
                request: JSON.stringify({
                    command: 'GFN_SDK_GET_SESSION_INFO'
                }),
                onSuccess: function (response) {
                    var data = JSON.parse(response);
                    setStatus('Got session info: ' + response);
                },
                onFailure: function (response) {
                    setStatus('Failed to get session Info: ' + JSON.stringify(response));
                }
            });
        }

        function setButtonState(isCloud) {
            // For APIs that work on both client and cloud systems, we'll auto-enable them here
            document.getElementById('init-control').setAttribute("class", 'nv-button flyout-button');
            document.getElementById('init-control').disabled = false;  
            document.getElementById('is-running-in-cloud').setAttribute("class", 'nv-button flyout-button');
            document.getElementById('is-running-in-cloud').disabled = false; 
            document.getElementById('is-running-in-cloud-secure').setAttribute("class", 'nv-button flyout-button');
            document.getElementById('is-running-in-cloud-secure').disabled = false; 
            document.getElementById('cloud-check-validation').setAttribute("class", 'nv-button flyout-button');
            document.getElementById('cloud-check-validation').disabled = false; 
            document.getElementById('cloud-check-no-validation').setAttribute("class", 'nv-button flyout-button');
            document.getElementById('cloud-check-no-validation').disabled = false; 
            document.getElementById('send-message').setAttribute("class", 'nv-button flyout-button');
            document.getElementById('send-message').disabled = false; 

            if (isCloud) {
                // Is cloud system, disable all client-specific buttons and enable all cloud-specific buttons
                document.getElementById('next-game').setAttribute("class", 'nv-button-disabled nv-chevron nv-chevron-right-align');
                document.getElementById('next-game').disabled = true;
                document.getElementById('previous-game').setAttribute("class", 'nv-button-disabled nv-chevron');
                document.getElementById('previous-game').disabled = true;

                document.getElementById('client-ip').setAttribute("class", 'nv-button flyout-button');
                document.getElementById('client-ip').disabled = false;
                document.getElementById('client-country-code').setAttribute("class", 'nv-button flyout-button');
                document.getElementById('client-country-code').disabled = false;
                document.getElementById('client-language-code').setAttribute("class", 'nv-button flyout-button');
                document.getElementById('client-language-code').disabled = false;
                document.getElementById('client-info').setAttribute("class", 'nv-button flyout-button');
                document.getElementById('client-info').disabled = false;
                document.getElementById('session-info').setAttribute("class", 'nv-button flyout-button');
                document.getElementById('session-info').disabled = false;
                document.getElementById('partner-data').setAttribute("class", 'nv-button flyout-button');
                document.getElementById('partner-data').disabled = false;
                document.getElementById('partner-secure-data').setAttribute("class", 'nv-button flyout-button');
                document.getElementById('partner-secure-data').disabled = false;
                document.getElementById('url-on-client').setAttribute("class", 'nv-button flyout-button');
                document.getElementById('url-on-client').disabled = false;
            }
            else {
                // Is client, enable client specific buttons and disable all cloud-specific buttons
                document.getElementById('next-game').setAttribute("class", 'nv-button nv-chevron nv-chevron-right-align');
                document.getElementById('next-game').disabled = false;
                document.getElementById('previous-game').setAttribute("class", 'nv-button nv-chevron');
                document.getElementById('previous-game').disabled = false;
                document.getElementById('stream-action').setAttribute("class", 'nv-button flyout-button');
                document.getElementById('stream-action').disabled = false;

                document.getElementById('client-ip').setAttribute("class", 'nv-button-disabled flyout-button');
                document.getElementById('client-ip').disabled = true;
                document.getElementById('client-country-code').setAttribute("class", 'nv-button-disabled flyout-button');
                document.getElementById('client-country-code').disabled = true;
                document.getElementById('client-language-code').setAttribute("class", 'nv-button-disabled flyout-button');
                document.getElementById('client-language-code').disabled = true;
                document.getElementById('client-info').setAttribute("class", 'nv-button-disabled flyout-button');
                document.getElementById('client-info').disabled = true;
                document.getElementById('session-info').setAttribute("class", 'nv-button-disabled flyout-button');
                document.getElementById('session-info').disabled = true;
                document.getElementById('partner-data').setAttribute("class", 'nv-button-disabled flyout-button');
                document.getElementById('partner-data').disabled = true;
                document.getElementById('partner-secure-data').setAttribute("class", 'nv-button-disabled flyout-button');
                document.getElementById('partner-secure-data').disabled = true;
                document.getElementById('url-on-client').setAttribute("class", 'nv-button-disabled flyout-button');
                document.getElementById('url-on-client').disabled = true;
            }
        }

        function updateStreamButton() {
            if (streamRunning == false) {
                document.getElementById('stream-action').innerHTML = 'Start <br> Stream';
                document.getElementById('stream-action').disabled = false;

                document.getElementById('send-message').disabled = true;
                document.getElementById('send-message').setAttribute("class", 'nv-button-disabled flyout-button');
            }
            else {
                document.getElementById('stream-action').innerHTML = 'Stop <br> Stream';
                document.getElementById('stream-action').disabled = false;

                document.getElementById('send-message').disabled = false;
                document.getElementById('send-message').setAttribute("class", 'nv-button flyout-button');
            }
        }

        document.addEventListener("DOMContentLoaded", function (event) {
            initializeSdk().then(function () {
                // Check if we're running on the game seat both ways to
                // decide if we should get the supported titles
                isRunningInCloudSecure();
                isRunningInCloud().then(function (isCloud) {
                    setButtonState(isCloud);
                    if (!isCloud) {
                        registerStreamStatusCallback();
                        registerMessageCallback(function (resp) {
                            var data = JSON.parse(resp);
                            setStatus('Message from cloud: ' + data.message);
                        });
                        getSupportedTitles().then(function (titles) {
                            // Some titles may not have cmsids assigned
                            supportedTitlesAsJson = []
                            for (title of titles) {
                                if (title.variants.length >= 1) {
                                    supportedTitlesAsJson.push(title);
                                } else {
                                    setStatus('removing title ' + JSON.stringify(title));
                                }
                            }
                            nextGame(0);
                        }, function (error) {
                            setStatus('getSupportedTitles failed with ' + error);
                        });
                    }
                    else {
                        setStatus('Running in GFN Cloud, skipping getting Supported Titles');
                        registerClientInfoCallback();
                        registerMessageCallback(function (resp) {
                            var data = JSON.parse(resp);
                            setStatus('Message from client: ' + data.message);

                            var responseMsg = 'ACK ' + data.message;
                            setStatus('Returning message to client: ' + responseMsg);
                            sendMessage(responseMsg, isCloud);
                        });
                    }
                });
            }, function (error) {
                setStatus('initializeSdk failed with ' + error);
            });
        });
    </script>
</body>
</html>
